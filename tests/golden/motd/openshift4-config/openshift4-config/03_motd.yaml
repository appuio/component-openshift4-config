apiVersion: espejote.io/v1alpha1
kind: ManagedResource
metadata:
  annotations:
    syn.tools/description: |
      Composes the message of the day from manual entries in the syn hierarchy and active consolenotifications on the cluster.
  labels:
    app.kubernetes.io/name: motd-composer
  name: motd-composer
  namespace: openshift-config
spec:
  applyOptions:
    force: true
  context:
    - name: consolenotifications
      resource:
        apiVersion: console.openshift.io/v1
        kind: ConsoleNotification
        labelSelector:
          matchLabels:
            appuio.io/notification: 'true'
  serviceAccountRef:
    name: motd-manager
  template: |
    local esp = import 'espejote.libsonnet';
    local config = import 'motd/config.json';

    local formatConsoleNotification(cn) =
      local text = cn.spec.text;
      local link = if std.objectHas(cn.spec, 'link') then
        std.join(': ', [ std.get(cn.spec.link, 'text', 'link'), std.get(cn.spec.link, 'href') ]);
      std.join('\n', [ text, link ]);

    local synMessages = std.prune([ config.motd.messages[m] for m in std.objectFields(config.motd.messages) ]);

    local consoleMessages = [ formatConsoleNotification(n) for n in esp.context().consolenotifications ];

    local messages = if config.motd.include_console_notifications then
      synMessages + consoleMessages
    else
      synMessages;

    local sep = '\n----------------------------------------\n';

    local makeMotdCM(m) =
      {
        apiVersion: 'v1',
        kind: 'ConfigMap',
        metadata: {
          name: 'motd',
          namespace: 'openshift',
        },
        data: {
          message: sep + std.join(sep, m) + sep,
        },
      };

    if std.length(messages) > 0 then
      makeMotdCM(messages)
    else
      esp.markForDelete(makeMotdCM([]))
  triggers:
    - name: consolenotifications
      watchContextResource:
        name: consolenotifications
    - name: jsonnetlib
      watchResource:
        apiVersion: espejote.io/v1alpha1
        kind: JsonnetLibrary
        name: motd
        namespace: openshift-config
---
apiVersion: espejote.io/v1alpha1
kind: JsonnetLibrary
metadata:
  labels:
    app.kubernetes.io/name: motd
  name: motd
  namespace: openshift-config
spec:
  data:
    config.json: |-
      {
          "motd": {
              "include_console_notifications": true,
              "messages": {
                  "emtpy_message": null,
                  "greeting": "Welcome to APPUiO",
                  "upgrade": "This cluster will soon be upgraded."
              }
          }
      }
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations: {}
  labels:
    name: appuio-motd-editor
  name: appuio:motd-editor
rules:
  - apiGroups:
      - console.openshift.io
    resources:
      - consolenotifications
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - espejote.io
    resources:
      - jsonnetlibraries
    verbs:
      - get
      - list
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations: {}
  labels:
    name: appuio-motd-manager
  name: appuio:motd-manager
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: appuio:motd-editor
subjects:
  - kind: ServiceAccount
    name: motd-manager
    namespace: openshift-config
---
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations: {}
  labels:
    name: motd-manager
  name: motd-manager
  namespace: openshift-config
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  annotations: {}
  labels:
    name: appuio-motd-manager
  name: appuio:motd-manager
  namespace: openshift
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: edit
subjects:
  - kind: ServiceAccount
    name: motd-manager
    namespace: openshift-config
